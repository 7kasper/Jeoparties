<!DOCTYPE HTML>
<html>
    <head>
        <title>Jeoparties</title>
        <script src="jquery-3.6.0.min.js"></script>
        <script src="jquery.textfill.min.js"></script>
        <script src="game.js"></script>
        <style>
            * {
                font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
                font-size: 1.6vw;
            }
            :root {
                --jbackground: #010a78;
                --jmoneycolor: #d7a04b;
            }
            html {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
                width: 100vw;
            }
            body {
                background-color: black;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            #gamecontent {
                display: flex;
                justify-content: space-evenly;
            }
            .catcolumn {
                margin-right: 0.3125rem;
            }
            .card {
                background-color: var(--jbackground);
                width: 5.6rem;
                height: 2.975rem;
                padding: 0.2rem;
                text-align: center; /*Show this V*/
                transition: opacity ease-in-out 1s, background-color ease-in-out 0.01s;
            }
            .catagory.card {
                color: white;
                margin-bottom: 0.625rem;
                text-shadow: 2px 2px 2px black;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .moneycard {
                font-size: 2rem;
                display: block;
                color: var(--jmoneycolor);
                margin-bottom: 0.3125rem;
                line-height: 2.75rem;
                text-shadow: 5px 5px 2px black;
            }
            .taken {
                opacity: 0;
                background-color: white;
            }
            #board {
                display: flex;
            }
            .playerinfos {
                display: inline-flex;
                flex-direction: column;
                flex-wrap: wrap;
                max-height: 21.125rem;
                width: fit-content;
            }
            .playerinfo {
                display: flex;
                justify-content: center;
                flex-direction: column;
                margin-bottom: 0.3125rem;
                margin-right: 0.3125rem;
            }
            .playername {
                color: white;
                text-shadow: 2px 2px 2px black;
            }
            .playermoney {
                color: var(--jmoneycolor);
                text-shadow: 5px 5px 2px black;
            }
            #sideboard {
                width: auto;
                overflow: inherit;
            }
            #sideboard .catagory.card {
                width: calc(100% - 0.625rem);
            }
            #boardwrapper {
                position: relative;
            }
            #questionoverlay {
                background-color: var(--jbackground);
                color: white;
                width: calc(100% - 0.3125rem);
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                transition: transform 0.4s ease-in-out;
            }
            .zoomedout {
                transform: scale(1);
            }
            .zoomedin {
                transform: scale(0);
            }
            #questionoverlay span {
                text-align: center;
                padding-top: 1rem;
            }
            #specialquestionbox {
                max-height: 70%;
                box-sizing: border-box;
            }
            #specialquestionbox .content {
                box-sizing: border-box;
                max-height: 100%;
                width: auto;
                transition: transform 0.5s ease-in-out;
            }
            #specialquestionbox .smallcontent {
                box-sizing: border-box;
                max-height: 50%;
                width: auto;
                transition: transform 0.5s ease-in-out;
            }
            .bordershadow {
                border: 3px solid black;
                filter: drop-shadow(2px 4px 6px black);
            }
            #titleimage {
                width: 14rem;
                margin-bottom: 0.625rem;
                margin-top: 0.3125rem;

            }
            .center {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <div class="center"><img id="titleimage" src="Jeopardy.svg"/></div>
        <div id="gamecontent">
            <div id="boardwrapper">
                <div id="board">
                    <div class="catcolumn">
                        <div class="catagory card">
                            <span>Ballgames</span>
                        </div>
                        <div class="moneycards">
                            <div class="moneycard card">
                                $200
                            </div>
                            <div class="moneycard card">
                                $400
                            </div>
                            <div class="moneycard card">
                                $600
                            </div>
                            <div class="moneycard card">
                                $800
                            </div>
                            <div class="moneycard card">
                                $1000
                            </div>
                        </div>
                    </div>
                    <div class="catcolumn">
                        <div class="catagory card">
                            <span>Ballgames that start with s and end with occer.</span>
                        </div>
                        <div class="moneycards">
                            <div class="moneycard card">
                                $200
                            </div>
                            <div class="moneycard card">
                                $400
                            </div>
                            <div class="moneycard card">
                                $600
                            </div>
                            <div class="moneycard card">
                                $800
                            </div>
                            <div class="moneycard card">
                                $1000
                            </div>
                        </div>
                    </div>
                    <div class="catcolumn">
                        <div class="catagory card">
                            <span>Ballgames</span>
                        </div>
                        <div class="moneycards">
                            <div class="moneycard card">
                                $200
                            </div>
                            <div class="moneycard card">
                                $400
                            </div>
                            <div class="moneycard card">
                                $600
                            </div>
                            <div class="moneycard card">
                                $800
                            </div>
                            <div class="moneycard card">
                                $1000
                            </div>
                        </div>
                    </div>
                    <div class="catcolumn">
                        <div class="catagory card">
                            <span>Ballgames</span>
                        </div>
                        <div class="moneycards">
                            <div class="moneycard card">
                                $200
                            </div>
                            <div class="moneycard card">
                                $400
                            </div>
                            <div class="moneycard card taken">
                                $600
                            </div>
                            <div class="moneycard card">
                                $800
                            </div>
                            <div class="moneycard card">
                                $1000
                            </div>
                        </div>
                    </div>
                    <div class="catcolumn">
                        <div class="catagory card">
                            <span>Chess</span>
                        </div>
                        <div class="moneycards">
                            <div class="moneycard card">
                                $200
                            </div>
                            <div class="moneycard card">
                                $400
                            </div>
                            <div class="moneycard card">
                                $600
                            </div>
                            <div class="moneycard card">
                                $800
                            </div>
                            <div class="moneycard card">
                                $1000
                            </div>
                        </div>
                    </div>
                    <div class="catcolumn">
                        <div class="catagory card">
                            <span>Chess</span>
                        </div>
                        <div class="moneycards">
                            <div class="moneycard card">
                                $200
                            </div>
                            <div class="moneycard card">
                                $400
                            </div>
                            <div class="moneycard card">
                                $600
                            </div>
                            <div class="moneycard card">
                                $800
                            </div>
                            <div class="moneycard card">
                                $1000
                            </div>
                        </div>
                    </div>
                </div>
                <div id="questionoverlay" class="zoomedout resizetext">
                    <span>Loading the board...</span>
                    <div id="specialquestionbox"></div>
                    <span></span>
                </div>
            </div>
            <div id="sideboard">
                <div id="playercat" class="catagory card">
                    <span>Players</span>
                </div>
                <div class="playerinfos">
                    <div class="playerinfo card">
                        <div class="playername">Kasper</div>
                        <div class="playermoney">$0</div>
                    </div>
                    <div class="playerinfo card">
                        <div class="playername">Eric</div>
                        <div class="playermoney">$0</div>
                    </div>
                </div>
            </div>
        </div>
        <script>

            let host = confirm('Play as host?');
            let hostPwd = '';
            if (host) {
                hostPwd = prompt('Host password');
            }

            registerHandler('onOpen', () => {
                rpc('/register', {host, hostPwd});
            });
            registerHandler('onError', (error) => alert(`Error [${error.code}]: ${error.error}`))
            


            let shownCatagoryId = -1;
            let shownQuestionId = -1;
            let insideSpecialQuestion = false;

            function doResize() {
                $('.catagory.card,.resizetext').textfill({
                    maxFontPixels: 90
                });
                $('.playerinfos').each(function( index ) {
                    var lastChild = $(this).children().last();
                    var newWidth = lastChild.position().left - $(this).position().left + lastChild.outerWidth(true);
                    $(this).width(newWidth);
                });
            }

            // Definitions
            
            function timeout(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            let board = {};
            // definition players
            let players = [];

            // Loads in the questions and draws the board.
            async function drawBoard() {
                let domQuestionOverlay = document.getElementById('questionoverlay');
                domQuestionOverlay.firstElementChild.innerText = board.name;
                domQuestionOverlay.lastElementChild.innerText = '';
                doResize();
                domQuestionOverlay.classList.add('zoomedout');
                domQuestionOverlay.classList.remove('zoomedin');
                await timeout(300);

                let domBoard = document.getElementById('board');
                while (domBoard.firstChild) {
                    domBoard.removeChild(domBoard.lastChild);
                }
                for (let catId = 0; catId < board.catagories.length; catId++) {
                    let cat = board.catagories[catId];
                    let domCatColumn = document.createElement('div');
                    domCatColumn.classList.add('catcolumn');
                    let domCatCard = document.createElement('div');
                    domCatCard.classList.add('catagory', 'card');
                    let domCatCardSpan = document.createElement('span');
                    domCatCardSpan.innerText = cat.name;
                    domCatCard.appendChild(domCatCardSpan);
                    domCatColumn.appendChild(domCatCard);
                    let domMoneyCards = document.createElement('div');
                    domCatColumn.classList.add('moneycards');
                    for (let qId = 0; qId < cat.questions.length; qId++) {
                        let question = cat.questions[qId];
                        // Question loading setup:
                        switch (question.kind) {
                            case 'photo':
                                let domIMG = document.createElement('img');
                                domIMG.classList.add('bordershadow', 'content');
                                domIMG.src = question.url;
                                question.domObj = domIMG;
                                if (question.urlans) {
                                    let domAnsIMG = document.createElement('img');
                                    domAnsIMG.classList.add('bordershadow', 'content');
                                    domAnsIMG.src = question.urlans;
                                    question.domAnsObj = domAnsIMG;
                                }
                                break;
                            case 'audio':
                                let speakerIMG = document.createElement('img');
                                speakerIMG.classList.add('content');
                                speakerIMG.src = '/speaker.png';
                                question.domObj = speakerIMG;
                                question.domAnsObj = new Audio(question.url);
                            break;
                            case 'video':
                                let domVID = document.createElement('video');
                                domVID.classList.add('bordershadow', 'content');
                                domVID.src = question.url;
                                domVID.load();
                                question.domObj = domVID;
                                break;
                            case 'normal':
                            default:
                                break;
                        }


                        let domMoneyCard = document.createElement('div');
                        domMoneyCard.classList.add('moneycard', 'card');
                        domMoneyCard.innerText = `$${question.value}`;
                        if (question.taken) {
                            domMoneyCard.classList.add('taken');
                        }
                        if (host) {
                            domMoneyCard.onclick = () => {
                                if (!question.taken) {
                                    if (question.special) {
                                        rpc('/showspecial', {catId, qId, special: question.special});
                                    } else {
                                        // showQuestion(catId, qId);
                                        rpc('/showquestion', {catId, qId});
                                    }
                                }
                            };
                        }
                        domMoneyCards.appendChild(domMoneyCard);
                    }
                    domCatColumn.appendChild(domMoneyCards);
                    domBoard.appendChild(domCatColumn);
                }
                doResize();
                setTimeout(() => {
                    domQuestionOverlay.classList.remove('zoomedout');
                    domQuestionOverlay.classList.add('zoomedin');
                }, 2000);
                
            }
            function drawPlayers() {
                let domSideBoard = document.getElementById('sideboard');
                let domPlayerInfos = domSideBoard.lastElementChild;
                while (domPlayerInfos.firstChild) {
                    domPlayerInfos.removeChild(domPlayerInfos.lastChild);
                }
                for (let i = 0; i < players.length; i++) {
                    let player = players[i];
                    let domPlayerInfoCard = document.createElement('div');
                    domPlayerInfoCard.classList.add('playerinfo', 'card');
                    let domPlayerName = document.createElement('div');
                    domPlayerName.classList.add('playername');
                    domPlayerName.innerText = player.name;
                    domPlayerInfoCard.appendChild(domPlayerName);
                    let domPlayerMoney = document.createElement('div');
                    domPlayerMoney.classList.add('playermoney');
                    domPlayerMoney.innerText = `$${player.money}`;
                    domPlayerInfoCard.appendChild(domPlayerMoney);
                    if (host) {
                        domPlayerInfoCard.onclick = () => {
                            if (shownQuestionId != -1) {
                                let question = board.catagories[shownCatagoryId].questions[shownQuestionId];
                                if (insideSpecialQuestion) {
                                    let tempwager = parseInt(prompt(`Place wager for ${player.name}`));
                                    if (tempwager > player.money) {
                                        alert(`Cannot wager more (${player.wager}) than your money (${player.money})!`);
                                        return;
                                    }
                                    player.wager = tempwager;
                                    if (question.special === 'dailydouble') {
                                        rpc('/showquestion', {catId: shownCatagoryId, qId: shownQuestionId});
                                    } else if (question.special === 'finaljeopardy') {
                                        // only place wager.
                                    }
                                } else {
                                    if (player.wager > 0) {
                                        player.money += player.wager;
                                        player.wager = -1;
                                    } else {
                                        player.money += board.catagories[shownCatagoryId].questions[shownQuestionId].value;
                                    }
                                    if (question.special !== 'finaljeopardy') {
                                        rpc('/hidequestion', {catId: shownCatagoryId, qId: shownQuestionId, vaux: false});
                                    }
                                }
                                // hideQuestion(shownCatagoryId, shownQuestionId);
                            } else {
                                if (confirm(`Are you sure you wish to remove ${player.name}?`)) {
                                    players.splice(i, 1);
                                }
                            }
                            rpc('/updateplayers', {players: players});
                            // drawPlayers();
                        };
                    }
                    domPlayerInfos.appendChild(domPlayerInfoCard);
                }
            }
            function crossQuestion(catagoryId, questionId) {
                let domBoard = document.getElementById('board');
                // Goes into the board. Gets the n-th catagory, then in the moneycards div it takes the n-th question 
                // and adds the taken class to it. In order to show the crossing-out animation.
                domBoard.children[catagoryId].lastElementChild.children[questionId].classList.add('taken');

                let lastQuestion = true;
                notlastq:
                for(let i = 0; i < board.catagories.length; i++) {
                    for (let j = 0; j < board.catagories[i].questions.length; j++) {
                        if (!board.catagories[i].questions[j].taken) {
                            lastQuestion = false;
                            break notlastq;
                        }
                    }
                }
                
                if (lastQuestion) {
                    let domQuestionOverlay = document.getElementById('questionoverlay');
                    domQuestionOverlay.firstElementChild.innerText = 'Board cleared!';
                    domQuestionOverlay.lastElementChild.innerText = '';
                    doResize();
                    domQuestionOverlay.classList.add('zoomedout');
                    domQuestionOverlay.classList.remove('zoomedin');
                }
            }
            function showQuestion(catagoryId, questionId) {
                insideSpecialQuestion = false;
                let question = board.catagories[catagoryId].questions[questionId];
                let domQuestionOverlay = document.getElementById('questionoverlay');
                domQuestionOverlay.firstElementChild.innerText = question.text;
                if (host) {
                    domQuestionOverlay.lastElementChild.innerText = question.answer;
                } else {
                    domQuestionOverlay.lastElementChild.innerText = '';

                }
                if (question.kind && question.kind !== 'normal') {
                    domQuestionOverlay.classList.remove('resizetext');
                    domQuestionOverlay.firstElementChild.style.fontSize = '2rem';
                    document.getElementById('specialquestionbox').appendChild(question.domObj);
                }
                domQuestionOverlay.classList.remove('zoomedin');
                domQuestionOverlay.classList.add('zoomedout');
                shownCatagoryId = catagoryId;
                shownQuestionId = questionId;
                // crossQuestion(catagoryId, questionId);
                doResize();
            }
            function hideQuestion(catagoryId, questionId, vaux = false) {
                let question = board.catagories[catagoryId].questions[questionId];
                let domQuestionOverlay = document.getElementById('questionoverlay');

                domQuestionOverlay.classList.add('resizetext');
                domQuestionOverlay.classList.add('zoomedin');
                domQuestionOverlay.classList.remove('zoomedout');
                shownCatagoryId = -1;
                shownQuestionId = -1;
                if (vaux) {
                    setTimeout(() => {
                        let sqBox = document.getElementById('specialquestionbox');
                        while (sqBox.firstChild) {
                            sqBox.removeChild(sqBox.lastChild);
                        }
                        switch (question.kind) {
                            case 'video':
                                question.domObj.pause();
                                question.domObj.currentTime = 0;
                                break;
                            case 'audio':
                                question.domAnsObj.pause();
                                question.domAnsObj.currentTime = 0;
                            break;
                            default:
                                break;
                        }
                    }, 500);
                } else {
                    switch (question.kind) {
                            case 'video':
                                question.domObj.pause();
                                question.domObj.currentTime = 0;
                                break;
                            case 'audio':
                                question.domAnsObj.pause();
                                question.domAnsObj.currentTime = 0;
                            break;
                            default:
                                break;
                        }
                    board.catagories[catagoryId].questions[questionId].taken = true;
                    setTimeout(() => {
                        // Remove possible video.
                        if (question.domObj) question.domObj.remove();
                        if (question.domAnsObj) question.domAnsObj.remove();
                        let sqBox = document.getElementById('specialquestionbox');
                        while (sqBox.firstChild) {
                            sqBox.removeChild(sqBox.lastChild);
                        }
                        crossQuestion(catagoryId, questionId);
                    }, 500);
                }
            }

            function showSpecial(catagoryId, questionId, special) {
                let question = board.catagories[catagoryId].questions[questionId];
                let domQuestionOverlay = document.getElementById('questionoverlay');
                domQuestionOverlay.classList.add('resizetext')
                switch (special) {
                    case 'dailydouble':
                        domQuestionOverlay.firstElementChild.innerText = 'DAILY DOUBLE!';
                        domQuestionOverlay.lastElementChild.innerText = '';
                        break;
                    case 'finaljeopardy':
                        domQuestionOverlay.firstElementChild.innerText = 'FINAL JEOPARDY!';
                        domQuestionOverlay.lastElementChild.innerText = 'Place a wager.';
                        break;
                    default:
                        domQuestionOverlay.firstElementChild.innerText = 'Special Question!';
                        domQuestionOverlay.lastElementChild.innerText = '';
                        break;
                }
                domQuestionOverlay.classList.remove('zoomedin');
                domQuestionOverlay.classList.add('zoomedout');
                shownCatagoryId = catagoryId;
                shownQuestionId = questionId;
                insideSpecialQuestion = true;
                doResize();
            }

            if (host) {
                document.getElementById('playercat').onclick = function() {
                    if (shownQuestionId != -1) {
                        if (insideSpecialQuestion) {
                            rpc('/showquestion', {catId: shownCatagoryId, qId: shownQuestionId});
                        } else {
                            // hideQuestion(shownCatagoryId, shownQuestionId);
                            let lazyplayerupdate = false;
                            for (let i = 0; i < players.length; i++) {
                                let player = players[i];
                                if (player.wager > 0) {
                                    player.money -= player.wager;
                                    player.wager = -1;
                                    lazyplayerupdate = true;
                                }
                            }
                            if (lazyplayerupdate) rpc('/updateplayers', {players: players});
                            rpc('/hidequestion', {catId: shownCatagoryId, qId: shownQuestionId, vaux: false});
                        }

                    } else {
                        let newname = prompt('Enter playername:');
                        if (newname) {
                            players.push({name: newname, money: 0});
                            // drawPlayers();
                            rpc('/updateplayers', {players});
                        }
                    }
                };
                document.getElementById('titleimage').onclick = function() {
                    if (shownQuestionId != -1) {
                        rpc('/hidequestion', {catId: shownCatagoryId, qId: shownQuestionId, vaux: true});
                    } else {
                        if (confirm('Move to next board?')) {
                            rpc('/nextboard');
                        }
                    }
                    
                };
                document.getElementById('specialquestionbox').onclick = function() {
                    rpc('/specialaction');
                }
            }
            window.onresize = doResize;
            doResize();

            // drawPlayers();

            registerHandler('showquestion', (body) => showQuestion(body.catId, body.qId));
            registerHandler('hidequestion', (body) => hideQuestion(body.catId, body.qId, body.vaux));
            registerHandler('showspecial', (body) => showSpecial(body.catId, body.qId, body.special));

            registerHandler('specialaction', async (body) => {
                if (shownQuestionId != -1) {
                    let question = board.catagories[shownCatagoryId].questions[shownQuestionId];
                    switch (question.kind) {
                        case 'photo':
                            // If photo has answer picture show it with animation.
                            if (question.urlans) {
                                let sqBox = document.getElementById('specialquestionbox');
                                question.domObj.style.transform = 'rotate3d(0, 1, 0, 90deg)';
                                question.domAnsObj.style.transform = 'rotate3d(0, 1, 0, 90deg)';
                                await timeout(500);
                                while (sqBox.firstChild) {
                                    sqBox.removeChild(sqBox.lastChild);
                                }
                                question.domObj.style.transform = 'rotate3d(0, 1, 0, 0deg)';
                                sqBox.appendChild(question.domAnsObj);
                                await timeout(100);
                                question.domAnsObj.style.transform = 'rotate3d(0, 1, 0, 0deg)';
                            }
                            break;
                        case 'audio':
                            if (question.domAnsObj.duration > 0 && !question.domAnsObj.paused) {
                                question.domAnsObj.pause();
                            } else {
                                question.domAnsObj.play();
                            }
                            break;
                        case 'video':
                            if (question.domObj.duration > 0 && !question.domObj.paused) {
                                question.domObj.pause();
                            } else {
                                question.domObj.play();
                            }
                            break;
                        break;
                        break;
                        default:
                            break;
                    }
                }
            });

            registerHandler('players', (body) => {
                players = body.players; 
                drawPlayers();
            });
            registerHandler('board', (body) => {
                board = body.board; 
                drawBoard();
            });

        </script>
    </body>
</html>